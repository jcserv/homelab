name: cd

on:
  workflow_run:
    workflows: ["ci"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Detect changed charts
        id: list-changed
        run: |
          # Find charts that changed in the last commit
          changed_files=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$changed_files"

          # Extract unique chart directories from changed files
          changed_charts=$(echo "$changed_files" | grep '^charts/' | cut -d/ -f1,2 | sort -u)

          if [[ -n "$changed_charts" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "charts<<EOF" >> "$GITHUB_OUTPUT"
            echo "$changed_charts" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "Detected changed charts:"
            echo "$changed_charts"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No chart changes detected"
          fi

      - name: Set up kubeconfig
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connectivity
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy changed charts
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          # Charts to exclude from auto-deployment:
          # - Charts with gitignored values.yaml (contain secrets)
          # - Charts with complex PVs that need manual intervention
          EXCLUDED_CHARTS=(
            "pihole"           # gitignored values.yaml
            "power-monitor"    # gitignored values.yaml
            "immich"           # complex PVs + database
            "home-assistant"   # complex PVs + USB devices
            "filebrowser"      # PVs with existing ownership issues
          )

          # Read the changed charts from the output
          changed_charts=$(cat <<'EOF'
          ${{ steps.list-changed.outputs.charts }}
          EOF
          )

          echo "ðŸš€ Deploying changed charts..."

          for chart in $changed_charts; do
            chart_name=$(basename "$chart")

            # Check if chart is excluded
            if [[ " ${EXCLUDED_CHARTS[@]} " =~ " ${chart_name} " ]]; then
              echo "â­ï¸  Skipping $chart_name (excluded from auto-deployment)"
              continue
            fi

            echo "ðŸ“¦ Processing chart: $chart_name"

            # Build dependencies from Chart.lock if it exists, otherwise update
            if [ -f "$chart/Chart.lock" ]; then
              echo "  â¬‡ï¸  Building dependencies from Chart.lock..."
              helm dependency build "$chart"
            elif grep -q "dependencies:" "$chart/Chart.yaml" 2>/dev/null; then
              echo "  â¬‡ï¸  Updating dependencies (no Chart.lock found)..."
              helm dependency update "$chart"
            fi

            # Determine namespace from chart values or use chart name
            namespace=$(yq eval '.namespace // "'$chart_name'"' "$chart/values.yaml" 2>/dev/null || echo "$chart_name")

            # Create namespace if it doesn't exist
            kubectl create namespace "$namespace" --dry-run=client -o yaml | kubectl apply -f -

            # Deploy the chart
            echo "  ðŸ”§ Deploying to namespace: $namespace"
            helm upgrade --install "$chart_name" "$chart" \
              --namespace "$namespace" \
              --create-namespace \
              --wait \
              --timeout 5m \
              --atomic

            echo "  âœ… Successfully deployed $chart_name"
          done

          echo "ðŸŽ‰ All charts deployed successfully!"

      - name: Deployment summary
        if: always() && steps.list-changed.outputs.changed == 'true'
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed charts:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.list-changed.outputs.charts }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
