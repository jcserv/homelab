name: ci

on:
  push:
    branches:
      - main
  pull_request:

permissions: {}

jobs:
  lint:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5.0.0

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1

      - uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.x"
          check-latest: true

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.8.0
        with:
          version: v3.8.0

      - name: Run chart-testing (list-changed)
        id: list-changed
        run: |
          changed=$(ct list-changed --target-branch ${{ github.event.repository.default_branch }})
          if [[ -n "$changed" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run chart-testing (lint)
        if: steps.list-changed.outputs.changed == 'true'
        run: ct lint --target-branch ${{ github.event.repository.default_branch }}

      - name: Create kind cluster
        if: steps.list-changed.outputs.changed == 'true'
        uses: helm/kind-action@v1.13.0

      - name: Run chart-testing (install)
        if: steps.list-changed.outputs.changed == 'true'
        run: ct install --target-branch ${{ github.event.repository.default_branch }}

  deploy:
    needs: [lint]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2.6.1

      - name: Add Helm repositories
        run: |
          helm repo add jetstack https://charts.jetstack.io
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo add metallb https://metallb.github.io/metallb
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
          helm repo update

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Detect changed charts
        id: list-changed
        run: |
          # Find charts that changed in the last commit
          changed_files=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$changed_files"

          # Extract unique chart directories from changed files
          changed_charts=$(echo "$changed_files" | grep '^charts/' | cut -d/ -f1,2 | sort -u)

          if [[ -n "$changed_charts" ]]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "charts<<EOF" >> "$GITHUB_OUTPUT"
            echo "$changed_charts" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "Detected changed charts:"
            echo "$changed_charts"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No chart changes detected"
          fi

      - name: Set up kubeconfig
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster connectivity
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy changed charts
        if: steps.list-changed.outputs.changed == 'true'
        run: |
          # Charts to exclude from auto-deployment:
          # - Charts with gitignored values.yaml (contain secrets)
          # - Charts with complex PVs that need manual intervention
          EXCLUDED_CHARTS=(
            "pihole"           # gitignored values.yaml
            "power-monitor"    # gitignored values.yaml
          )

          # Read the changed charts from the output
          changed_charts=$(cat <<'EOF'
          ${{ steps.list-changed.outputs.charts }}
          EOF
          )

          echo "ðŸš€ Deploying changed charts..."

          for chart in $changed_charts; do
            chart_name=$(basename "$chart")

            # Check if chart is excluded
            if [[ " ${EXCLUDED_CHARTS[@]} " =~ " ${chart_name} " ]]; then
              echo "â­ï¸  Skipping $chart_name (excluded from auto-deployment)"
              continue
            fi

            echo "ðŸ“¦ Processing chart: $chart_name"

            # Build dependencies from Chart.lock if it exists, otherwise update
            if [ -f "$chart/Chart.lock" ]; then
              echo "  â¬‡ï¸  Building dependencies from Chart.lock..."
              helm dependency build "$chart"
            elif grep -q "dependencies:" "$chart/Chart.yaml" 2>/dev/null; then
              echo "  â¬‡ï¸  Updating dependencies (no Chart.lock found)..."
              helm dependency update "$chart"
            fi

            # Determine namespace from chart values or use chart name
            namespace=$(yq eval '.namespace // "'$chart_name'"' "$chart/values.yaml" 2>/dev/null || echo "$chart_name")

            # Create namespace if it doesn't exist
            kubectl create namespace "$namespace" --dry-run=client -o yaml | kubectl apply -f -

            # Deploy the chart
            echo "  ðŸ”§ Deploying to namespace: $namespace"
            helm upgrade --install "$chart_name" "$chart" \
              --namespace "$namespace" \
              --create-namespace \
              --reset-values \
              --wait \
              --timeout 5m \
              --atomic

            # Force rollout restart for charts with ConfigMaps that don't auto-reload
            # This ensures pods pick up ConfigMap changes immediately
            RESTART_CHARTS=("alloy")
            if [[ " ${RESTART_CHARTS[@]} " =~ " ${chart_name} " ]]; then
              echo "  ðŸ”„ Restarting pods to pick up ConfigMap changes..."
              kubectl rollout restart daemonset/"$chart_name" -n "$namespace" 2>/dev/null || \
              kubectl rollout restart deployment/"$chart_name" -n "$namespace" 2>/dev/null || \
              kubectl rollout restart statefulset/"$chart_name" -n "$namespace" 2>/dev/null || \
              echo "  âš ï¸  No daemonset/deployment/statefulset found to restart"
              kubectl rollout status daemonset/"$chart_name" -n "$namespace" --timeout=3m 2>/dev/null || \
              kubectl rollout status deployment/"$chart_name" -n "$namespace" --timeout=3m 2>/dev/null || \
              kubectl rollout status statefulset/"$chart_name" -n "$namespace" --timeout=3m 2>/dev/null || true
            fi

            echo "  âœ… Successfully deployed $chart_name"
          done

          echo "ðŸŽ‰ All charts deployed successfully!"

      - name: Deployment summary
        if: always() && steps.list-changed.outputs.changed == 'true'
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed charts:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.list-changed.outputs.charts }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
